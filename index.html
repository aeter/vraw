<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />

    <title>Vraw</title>

    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.rawgit.com/Chalarangelo/mini.css/v3.0.1/dist/mini-default.min.css">

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>

    <style>
      #colorPicker {
        background-color: white;
        padding: 5px;
        border: none;
		max-width: 20px;
      }
      #vraw_canvas { 
        border: 1px solid gray; 
      }
      .cursor-brush {
        cursor: url(vendor/icons/font_awesome/paint-brush.svg) 0 32, auto;
      }
      .cursor-eraser {
        cursor: url(vendor/icons/font_awesome/eraser.svg) 0 32, auto;
      }
    </style>
  </head>
  <body>
    <header>
      <a href="#" class="logo"><i class="fa fa-pencil-ruler"></i>&nbsp;Vraw</a>
	  <a href="https://github.com/aeter/vraw" class="button"><i class="fa fa-code-branch"></i>&nbsp;Github</a>
    </header>
    <div class="container" id="vraw_app">
      <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
          <div class="button-group">
            <button class="primary tooltip shadowed" aria-label="New"><i class="fa fa-file"></i></button>

            <button class="primary tooltip shadowed" aria-label="Save" @click="download_image">
              <i class="fa fa-download"></i>
              <a href="#" id="downloader"></a>
            </button>

            <button class="primary tooltip shadowed" aria-label="Brush" 
              @click="selected = 'brush'" :class="selected == 'brush' ? 'secondary' : ''">
              <i class="fa fa-paint-brush"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Fill" 
              @click="selected = 'fill'" :class="selected == 'fill' ? 'secondary' : ''">
              <i class="fa fa-fill-drip"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Circle"
              @click="selected = 'circle'" :class="selected == 'circle' ? 'secondary' : ''">
              <i class="far fa-circle"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Square"
              @click="selected = 'square'" :class="selected == 'square' ? 'secondary' : ''">
              <i class="far fa-square"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Line"
              @click="selected = 'line'" :class="selected == 'line' ? 'secondary' : ''">
              <i class="fa fa-minus"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Eraser"
              @click="selected = 'eraser'" :class="selected == 'eraser' ? 'secondary': ''">
              <i class="fa fa-eraser"></i>
            </button>

            <button class="primary tooltip shadowed" aria-label="Color">
              <input type="color" v-model="color" id="colorPicker"></input>
			</button>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
          <canvas id="vraw_canvas" width="780" height="600" 
            :class="selected == 'eraser' ? 'cursor-eraser' : 'cursor-brush'"
            @mousedown="handle_mousedown"
            @mousemove="handle_mousemove"
            @mouseout="handle_mouseout"
            @mouseup="handle_mouseup">
          </canvas>
        </div>
      </div>
    </div>

    <script>
      var app = new Vue({
        el: '#vraw_app',
        data: {
          color: "#228B22",
          selected: 'brush',
          drawing: false,
          elements: [],
        },
        watch: {
          elements: function() {
            var canvas = document.getElementById('vraw_canvas')
            var context = canvas.getContext("2d");
            // clear canvas
            context.clearRect(0, 0, canvas.width, canvas.height);

            for (var element of this.elements) {
              // draw a line
              if (element.type == "line" && element.end !== undefined) {
                context.beginPath();
                context.strokeStyle = element.color;
                context.lineWidth = 5;
                context.moveTo(element.start.x, element.start.y);
                context.lineTo(element.end.x, element.end.y);
                context.stroke();
              }
            }
          }
        },
        methods: {
          download_image: function() {
            var link = document.getElementById('downloader');
            link.setAttribute('download', 'image.png');
            link.setAttribute('href', document.getElementById('vraw_canvas').toDataURL("image/png").replace("image/png", "image/octet-stream"));
            link.click();
          },
          handle_mousedown: function(e) {
            // drawing a line
            if (this.selected == "line") {
              var cursor_position = this.getCursorPosition(e);
              this.elements.push({type: "line", color: this.color, start: {x: cursor_position.x, y: cursor_position.y}})
            }
          },
          handle_mouseup: function(e) {
            // drawing a line
            if (this.selected == "line") {
              var last_element = this.elements[this.elements.length - 1];
              var cursor_position = this.getCursorPosition(e);
              last_element["end"] = {x: cursor_position.x, y: cursor_position.y};
              // because setting elements like x[a] = 5 is not supported by Vue
              this.elements.pop();
              this.elements.push(last_element);
            }
          },
          handle_mousemove: function(e) {
          },
          handle_mouseout: function(e) {
          },
          getCursorPosition(e) {
            var rect = document.getElementById('vraw_canvas').getBoundingClientRect();
            return {x: e.clientX - rect.left, y: e.clientY - rect.top};
          },
        },
      })
    </script>
  </body>
</html>
